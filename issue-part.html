<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Item - Spare Parts Inventory System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            #auditReportContainer,
            #auditReportContainer * {
                visibility: visible;
            }

            #auditReportContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .app-container {
                display: block !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            th,
            td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
                font-size: 12px;
            }

            th {
                background-color: #f2f2f2 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        #auditReportContainer {
            display: none;
            padding: 20px;
            background: white;
        }

        .audit-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .audit-footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
        }

        .sig-box {
            width: 200px;
            text-align: center;
        }

        .sig-line {
            border-top: 1px solid #333;
            margin-bottom: 5px;
        }

        .pick-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .inventory-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .inventory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #6366f1;
        }

        .inventory-card .sku {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 700;
        }

        .inventory-card .name {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
            height: 2.8em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .inventory-card .stock-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .inventory-card .price {
            font-weight: 800;
            color: #6366f1;
            font-size: 1.1rem;
        }

        .inventory-card .add-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s;
            cursor: pointer;
        }

        .inventory-card:hover .add-btn {
            background: #6366f1;
            color: white;
            transform: rotate(90deg);
        }

        .inventory-card.out-of-stock {
            opacity: 0.6;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .selector-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        /* Professional Scrollable Areas */
        .inventory-list-container {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
            padding-right: 10px;
            scroll-behavior: smooth;
        }

        .inventory-list-container::-webkit-scrollbar,
        .history-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .inventory-list-container::-webkit-scrollbar-track,
        .history-list-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .inventory-list-container::-webkit-scrollbar-thumb,
        .history-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .inventory-list-container::-webkit-scrollbar-thumb:hover,
        .history-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Professional History Sidebar */
        .history-list-container {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            padding-right: 8px;
            scroll-behavior: smooth;
        }

        .history-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .history-list-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .history-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .history-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .history-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 4px solid #6366f1;
        }

        .history-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: #6366f1;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .history-meta {
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .history-id {
            font-family: 'JetBrains Mono', monospace;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            color: #475569;
            font-size: 0.7rem;
        }

        .history-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .history-item-name {
            font-weight: 500;
            color: #1e293b;
        }

        .history-item-qty {
            background: #e0e7ff;
            color: #4338ca;
            padding: 1px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .history-footer {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #64748b;
            padding-top: 8px;
            border-top: 1px solid #f1f5f9;
        }

        /* Modal Item List */
        .modal-item-list {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .modal-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-item-row:last-child {
            border-bottom: none;
        }

        .modal-item-info {
            flex: 1;
        }

        .modal-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .modal-item-sku {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Dedicated Bulk Modal Styles */
        .bulk-item-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .bulk-item-table th,
        .bulk-item-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .bulk-item-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
        }

        .bulk-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .bulk-item-qty-input {
            width: 70px;
            height: 35px;
            padding: 5px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
        }

        .remove-bulk-btn {
            color: #ef4444;
            cursor: pointer;
            padding: 5px;
            transition: opacity 0.2s;
        }

        .remove-bulk-btn:hover {
            opacity: 0.7;
        }

        /* Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: #f8fafc;
        }

        .autocomplete-item .plate {
            font-weight: 700;
            color: #1e293b;
        }

        .autocomplete-item .meta {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Selection Chips */
        .selection-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .bike-chip {
            background: #6366f1;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .bike-chip .remove-chip {
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .bike-chip .remove-chip:hover {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cogs" style="margin-right: 10px;"></i>
                Tasslim Parts Manager
            </div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> <span
                            data-i18n="dashboard">Dashboard</span></a></li>
                <li><a href="inventory.html" class="nav-link"><i class="fas fa-boxes"></i> <span
                            data-i18n="inventory">Inventory</span></a></li>
                <li><a href="issue-part.html" class="nav-link active"><i class="fas fa-hand-holding"></i> <span
                            data-i18n="pickItem">Issue Part (Mapping)</span></a></li>
                <li><a href="suppliers.html" class="nav-link"><i class="fas fa-truck"></i> <span
                            data-i18n="suppliers">Suppliers</span></a></li>
                <li><a href="mechanics.html" class="nav-link"><i class="fas fa-wrench"></i> <span
                            data-i18n="mechanics">Mechanics</span></a></li>
                <li><a href="mechanic-history.html" class="nav-link"><i class="fas fa-history"></i> <span
                            data-i18n="mechanicHistory">Mechanic History</span></a></li>
                <li><a href="users.html" class="nav-link"><i class="fas fa-users-cog"></i> <span
                            data-i18n="users">Users</span></a></li>
                <li><a href="bikes.html" class="nav-link"><i class="fas fa-motorcycle"></i> <span
                            data-i18n="bikes">Bikes</span></a></li>
                <li><a href="reports.html" class="nav-link"><i class="fas fa-chart-line"></i> <span
                            data-i18n="reports">Reports</span></a></li>
                <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> <span
                            data-i18n="settings">Settings</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button class="nav-link" style="background:none;border:none;width:100%;text-align:left;cursor:pointer;"
                    onclick="App.toggleLanguage()"><i class="fas fa-language"></i> <span
                        data-i18n="translate">Translate</span></button>
                <a href="#" onclick="App.logout()" class="nav-link"><i class="fas fa-sign-out-alt"></i> <span
                        data-i18n="logout">Logout</span></a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center;">
                    <button class="menu-toggle" onclick="App.toggleSidebar()" style="margin-right: 15px;">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-title" data-i18n="pickItem">Pick Item (Issuance / Mapping)</div>
                </div>

                <div style="display: flex; gap: 15px; align-items: center;">
                    <div>
                        <input type="text" id="searchQuery" class="form-control" style="width: 250px; height: 40px;"
                            placeholder="Search..." onkeyup="PickItem.filterItems()" data-i18n="search">
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar" id="userInitials">AU</div>
                        <span id="userName">Admin User</span>
                    </div>
                </div>
            </header>

            <div class="pick-container">
                <div class="card"
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; padding: 15px 25px;">
                    <p style="color: #666; margin: 0;"><i class="fas fa-info-circle"></i> Use this screen to map spare
                        parts to mechanics and bikes for workshop jobs.</p>
                    <button class="btn btn-primary" onclick="PickItem.openPickModal()">
                        <i class="fas fa-plus"></i> Manual Issue
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 300px 1.2fr; gap: 20px;">
                    <!-- LEFT: Search and Cards -->
                    <div>
                        <h3 class="mb-20" style="font-size: 1.1rem;"><i class="fas fa-search"></i> Available Inventory
                        </h3>
                        <div class="inventory-list-container">
                            <div class="search-results" id="searchResults">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- MIDDLE: Selection Cart -->
                    <div>
                        <h3 class="mb-20" style="font-size: 1.1rem;"><i class="fas fa-shopping-basket"
                                style="color: #f39c12;"></i> Selection Cart</h3>
                        <div class="card" style="padding: 15px; height: fit-content; position: sticky; top: 20px;">
                            <div id="cartList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                                <div
                                    style="text-align: center; color: #94a3b8; padding: 20px; border: 2px dashed #e2e8f0; border-radius: 8px;">
                                    No parts selected
                                </div>
                            </div>
                            <div id="cartFooter" style="display: none;">
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; border-top: 1px solid #eee; padding-top: 15px;">
                                    <span style="font-size: 14px;">Total Items:</span>
                                    <span id="cartTotalQty">0</span>
                                </div>
                                <button class="btn btn-warning" style="width: 100%; height: 42px; font-weight: bold;"
                                    onclick="PickItem.openCartModal()">
                                    Issue Selection
                                </button>
                                <button class="btn btn-link"
                                    style="width: 100%; margin-top: 5px; color: #7f8c8d; font-size: 12px;"
                                    onclick="PickItem.clearCart()">
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Mapping history -->
                    <div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.1rem;"><i class="fas fa-history"></i> Recent Mappings
                            </h3>
                            <button class="btn btn-secondary" onclick="PickItem.printAuditReport()"
                                style="padding: 5px 12px; font-size: 12px;">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                        </div>
                        <div id="historyList" class="history-list-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Hidden Audit Report for Printing -->
                <div id="auditReportContainer">
                    <div class="audit-header">
                        <div style="font-size: 14px; font-weight: bold; color: #666; margin-bottom: 5px;">TASSLIM
                            WORKSHOP MANAGEMENT</div>
                        <h2 style="margin: 0; text-transform: uppercase; letter-spacing: 1px;">Spare Parts Issuance Log
                            (Audit Report)</h2>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">Report Date: <span id="auditReportDate"></span>
                        </p>
                    </div>

                    <table id="auditReportTable">
                        <thead>
                            <tr>
                                <th>Date Picked</th>
                                <th>Logged At</th>
                                <th>Issue ID</th>
                                <th>Product Name</th>
                                <th>Mechanic</th>
                                <th>Bike Plate(s)</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>

                    <div class="audit-footer">
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Technician Signature</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Workshop Supervisor</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Storekeeper Signature</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Pick Item Modal (Mapping) -->
    <div class="modal-overlay" id="pickModal">
        <div class="modal-content">
            <span class="close-modal" onclick="PickItem.closeModal()">&times;</span>
            <h2 data-i18n="pickItem">Pick Item</h2>

            <form id="pickForm" style="margin-top: 20px;">
                <input type="hidden" id="pickProductId">

                <div class="form-group">
                    <label class="form-label">Product</label>
                    <select id="pickProductSelect" class="form-control" onchange="PickItem.onProductChange()">
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Assign to Mechanic</label>
                        <select id="pickMechanic" class="form-control" required>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Quantity to Issue</label>
                        <input type="number" id="pickQuantity" class="form-control" min="1" value="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Bike (Search Plate #)</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="bikePlateSearch" class="form-control" autocomplete="off"
                            placeholder="Type plate number..."
                            onkeyup="PickItem.handleBikeInput(event, 'bikePlateSearch', 'bikeSuggestions', 'selectedBikeChips')">
                        <div id="bikeSuggestions" class="autocomplete-dropdown"></div>
                    </div>
                    <div id="selectedBikeChips" class="selection-chips"></div>
                </div>

                <div class="row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label"><i class="fas fa-calendar-alt" style="color: #6366f1;"></i> Date
                            Picked</label>
                        <input type="date" id="pickDate" class="form-control" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Issue ID</label>
                        <input type="text" id="pickIssueId" class="form-control" readonly style="background: #f1f5f9;">
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" style="background: #e74c3c; color: white; margin-right: 10px;"
                        onclick="PickItem.closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dedicated Bulk Issue Modal -->
    <div class="modal-overlay" id="bulkIssueModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" onclick="PickItem.closeBulkModal()">&times;</span>
            <h2 style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-boxes" style="color: #f39c12;"></i> Bulk Issuance
            </h2>
            <p style="color: #64748b; margin-bottom: 20px;">Review the selected parts and assign them to a mechanic.</p>

            <form id="bulkPickForm">
                <!-- Group 1: Metadata -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="font-size: 0.75rem; color: #475569;"><i
                                class="fas fa-calendar-alt" style="color: #6366f1;"></i> Date of Issuance</label>
                        <input type="date" id="bulkDate" class="form-control" required>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="font-size: 0.75rem; color: #475569;">Reference Issue ID</label>
                        <input type="text" id="bulkIssueId" class="form-control" readonly
                            style="background: rgba(255,255,255,0.5);">
                    </div>
                </div>

                <div
                    style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <p
                        style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 10px; text-transform: uppercase;">
                        Selected Parts</p>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="bulk-item-table">
                            <thead>
                                <tr>
                                    <th>Part Name / SKU</th>
                                    <th style="width: 100px; text-align: center;">Qty</th>
                                    <th style="width: 50px; text-align: right;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="bulkModalTbody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">Assign to Mechanic</label>
                        <select id="bulkMechanic" class="form-control" required>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bike (Type Plate # to Add)</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="bulkBikeSearch" class="form-control" autocomplete="off"
                                placeholder="Type plate number..." style="height: 38px;"
                                onkeyup="PickItem.handleBikeInput(event, 'bulkBikeSearch', 'bulkBikeSuggestions', 'bulkBikeChips')">
                            <div id="bulkBikeSuggestions" class="autocomplete-dropdown"></div>
                        </div>
                        <div id="bulkBikeChips" class="selection-chips"></div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button type="button" class="btn" style="background: #f1f5f9; color: #475569; margin-right: 10px;"
                        onclick="PickItem.closeBulkModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="padding: 10px 25px;">
                        <i class="fas fa-check-circle"></i> Confirm & Issue All
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script src="js/app.js"></script>
    <script>
        const PickItem = {
            data: [],
            mappings: [],
            cart: [], // Multi-item selection

            init: function () {
                this.loadData();
                this.renderCards();
                this.renderHistory();
                this.populateDropdowns();

                document.getElementById('pickForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveMapping(false); // Single mode
                });

                document.getElementById('bulkPickForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveMapping(true); // Bulk mode
                });

                // Auto-open issuance for deep links (from Inventory page)
                const urlParams = new URLSearchParams(window.location.search);
                const skuParam = urlParams.get('sku');
                if (skuParam) {
                    const product = this.data.find(p => p.sku === skuParam);
                    if (product) {
                        setTimeout(() => this.openPickModal(product.id), 100);
                    }
                }
            },

            loadData: function () {
                this.data = JSON.parse(localStorage.getItem(App.KEYS.INVENTORY)) || [];
                this.mappings = JSON.parse(localStorage.getItem(App.KEYS.MAPPINGS)) || [];
                this.sales = JSON.parse(localStorage.getItem(App.KEYS.SALES)) || [];
            },

            addToCart: function (id) {
                const product = this.data.find(p => p.id?.toString() === id.toString());
                if (!product) return;

                if (product.stock <= 0) {
                    App.showToast('Item is out of stock!', 'error');
                    return;
                }

                const existing = this.cart.find(c => c.id?.toString() === id.toString());
                if (existing) {
                    if (existing.qty < product.stock) {
                        existing.qty++;
                    } else {
                        App.showToast('Cannot exceed available stock!', 'error');
                        return;
                    }
                } else {
                    this.cart.push({
                        id: product.id,
                        name: product.name,
                        sku: product.sku,
                        price: product.price,
                        stock: product.stock,
                        qty: 1
                    });
                }

                this.renderCart();
            },

            removeFromCart: function (id) {
                this.cart = this.cart.filter(c => c.id?.toString() !== id.toString());
                this.renderCart();
            },

            updateCartQty: function (id, qty) {
                const item = this.cart.find(c => c.id?.toString() === id.toString());
                if (!item) return;

                const q = parseInt(qty);
                if (isNaN(q) || q < 1) return;

                if (q > item.stock) {
                    App.showToast('Insufficient stock!', 'error');
                    item.qty = item.stock;
                } else {
                    item.qty = q;
                }
                this.renderCart();
            },

            clearCart: function () {
                this.cart = [];
                this.renderCart();
            },

            renderCart: function () {
                const list = document.getElementById('cartList');
                const footer = document.getElementById('cartFooter');
                const totalQtyEl = document.getElementById('cartTotalQty');

                if (!list) return;

                if (this.cart.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: #94a3b8; padding: 20px; border: 2px dashed #e2e8f0; border-radius: 8px;">
                            No parts selected
                        </div>
                    `;
                    if (footer) footer.style.display = 'none';
                    return;
                }

                if (footer) footer.style.display = 'block';
                list.innerHTML = '';
                let totalQty = 0;

                this.cart.forEach(item => {
                    totalQty += item.qty;
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 10px; border-bottom: 1px solid #f1f5f9; position: relative; display: flex; justify-content: space-between; align-items: center;';
                    div.innerHTML = `
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.name}">${item.name}</div>
                            <div style="font-size: 11px; color: #94a3b8;">${item.sku}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" value="${item.qty}" min="1" max="${item.stock}" 
                                style="width: 50px; height: 28px; padding: 2px 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                onchange="PickItem.updateCartQty('${item.id}', this.value)">
                            <button style="background: none; border: none; color: #e74c3c; cursor: pointer; padding: 5px;" 
                                onclick="PickItem.removeFromCart('${item.id}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });

                if (totalQtyEl) totalQtyEl.textContent = totalQty;
            },

            populateDropdowns: function () {
                // Populate Mechanics
                const mechanics = JSON.parse(localStorage.getItem(App.KEYS.MECHANICS)) || [];
                const pickMechanic = document.getElementById('pickMechanic');
                pickMechanic.innerHTML = '<option value="">Select Mechanic</option>';
                mechanics.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.name;
                    option.textContent = m.name;
                    pickMechanic.appendChild(option);
                });

                // Populate Bulk Dropdowns too
                const bulkMechanic = document.getElementById('bulkMechanic');
                if (bulkMechanic) {
                    bulkMechanic.innerHTML = '<option value="">Select Mechanic</option>';
                    mechanics.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.name;
                        option.textContent = m.name;
                        bulkMechanic.appendChild(option);
                    });
                }
                const bikes = JSON.parse(localStorage.getItem(App.KEYS.BIKES)) || [];
                this.bikesData = bikes; // Keep for filtering
            },

            handleBikeInput: function (event, inputId, dropdownId, chipsId) {
                const input = document.getElementById(inputId);
                const dropdown = document.getElementById(dropdownId);
                const query = input.value.toLowerCase();

                if (!query) {
                    dropdown.style.display = 'none';
                    return;
                }

                const bikes = (this.bikesData || []).filter(b =>
                    b.plate.toLowerCase().includes(query) ||
                    (b.color && b.color.toLowerCase().includes(query))
                ).slice(0, 10); // Limit results

                if (bikes.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = bikes.map(b => `
                    <div class="autocomplete-item" onclick="PickItem.selectBike('${b.plate}', '${inputId}', '${dropdownId}', '${chipsId}')">
                        <span class="plate">${b.plate}</span>
                        <span class="meta">${b.brand || ''} ${b.model || ''} (${b.color || ''})</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';

                // Close dropdown when clicking outside
                const closeHandler = (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            },

            selectBike: function (plate, inputId, dropdownId, chipsId) {
                const chipsContainer = document.getElementById(chipsId);
                const input = document.getElementById(inputId);
                const dropdown = document.getElementById(dropdownId);

                // Prevent duplicates
                const existing = Array.from(chipsContainer.querySelectorAll('.bike-chip')).map(c => c.dataset.plate);
                if (!existing.includes(plate)) {
                    const chip = document.createElement('div');
                    chip.className = 'bike-chip';
                    chip.dataset.plate = plate;
                    chip.innerHTML = `
                        ${plate}
                        <span class="remove-chip" onclick="this.parentElement.remove()">&times;</span>
                    `;
                    chipsContainer.appendChild(chip);
                }

                input.value = '';
                dropdown.style.display = 'none';
                input.focus();
            },

            renderCards: function (items = this.data) {
                const container = document.getElementById('searchResults');
                if (!container) return;
                container.innerHTML = '';

                if (items.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #999;">No parts match your search.</div>';
                    return;
                }

                items.forEach(item => {
                    const stock = item.stock || 0;
                    const isOut = stock <= 0;
                    const isLow = stock > 0 && stock <= (item.minStock || 5);

                    const card = document.createElement('div');
                    card.className = `inventory-card ${isOut ? 'out-of-stock' : ''} ${isLow ? 'low-stock' : ''}`;
                    card.onclick = () => isOut ? null : this.addToCart(item.id);

                    card.innerHTML = `
                        <div class="add-btn"><i class="fas fa-plus"></i></div>
                        <div class="sku">${item.sku || 'N/A'}</div>
                        <div class="name">${item.name}</div>
                        <div class="stock-info">
                            <span class="badge ${isOut ? 'badge-danger' : (isLow ? 'badge-warning' : 'badge-success')}">
                                ${stock} ${item.unit || 'pc'}
                            </span>
                            <span class="price">${App.formatCurrency(item.price)}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },

            filterItems: function () {
                const query = document.getElementById('searchQuery').value.toLowerCase();
                const filtered = this.data.filter(i =>
                    (i.name || '').toLowerCase().includes(query) ||
                    (i.sku || '').toLowerCase().includes(query)
                );
                this.renderCards(filtered);
            },

            openCartModal: function () {
                if (this.cart.length === 0) return;

                const tbody = document.getElementById('bulkModalTbody');
                if (!tbody) return;

                // Clear suggestions and chips
                const suggestions = document.getElementById('bulkBikeSuggestions');
                if (suggestions) suggestions.style.display = 'none';
                const chips = document.getElementById('bulkBikeChips');
                if (chips) chips.innerHTML = '';

                tbody.innerHTML = '';
                this.cart.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="bulk-item-name">${item.name}</div>
                            <div style="font-size: 0.7rem; color: #64748b;">${item.sku}</div>
                        </td>
                        <td style="text-align: center;">
                            <input type="number" class="bulk-item-qty-input" value="${item.qty}" min="1" max="${item.stock}" 
                                onchange="PickItem.updateCartQty('${item.id}', this.value); PickItem.openCartModal();">
                        </td>
                        <td style="text-align: right;">
                            <div class="remove-bulk-btn" onclick="PickItem.removeFromCart('${item.id}'); PickItem.openCartModal(); if(PickItem.cart.length === 0) PickItem.closeBulkModal();">
                                <i class="fas fa-trash-alt"></i>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('bulkIssueId').value = 'ISS-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                document.getElementById('bulkDate').value = new Date().toISOString().split('T')[0];
                const bulkSearch = document.getElementById('bulkBikeSearch');
                if (bulkSearch) {
                    bulkSearch.value = '';
                }
                document.getElementById('bulkIssueModal').classList.add('open');
            },

            closeBulkModal: function () {
                document.getElementById('bulkIssueModal').classList.remove('open');
            },

            openPickModal: function (id = null) {
                const productSelect = document.getElementById('pickProductSelect');
                const productNameInput = document.getElementById('pickProductName');
                const quantityInput = document.getElementById('pickQuantity');

                if (quantityInput) quantityInput.parentElement.style.display = 'block';

                // Populate product select if not already done
                if (productSelect && productSelect.options.length <= 1) {
                    productSelect.innerHTML = '<option value="">Select a Product</option>';
                    this.data.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.name} (${p.sku}) - Stock: ${p.stock}`;
                        productSelect.appendChild(opt);
                    });
                }

                if (id) {
                    // Mapping specific item from card
                    const item = this.data.find(i => i.id?.toString() === id.toString());
                    if (item) {
                        document.getElementById('pickProductId').value = item.id;
                        if (productNameInput) {
                            productNameInput.value = item.name;
                            productNameInput.style.display = 'block';
                        }
                        if (productSelect) productSelect.style.display = 'none';
                        if (quantityInput) quantityInput.max = item.stock;
                    }
                } else {
                    // Manual issue from button
                    document.getElementById('pickProductId').value = '';
                    if (productNameInput) productNameInput.style.display = 'none';
                    if (productSelect) {
                        productSelect.style.display = 'block';
                        productSelect.value = '';
                    }
                    if (quantityInput) {
                        quantityInput.max = 1;
                        quantityInput.value = 1;
                    }
                }

                this.openPickModalCommon();
            },

            openPickModalCommon: function () {
                document.getElementById('pickIssueId').value = 'ISS-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                document.getElementById('pickDate').value = new Date().toISOString().split('T')[0];

                // Clear suggestions and chips
                const suggestions = document.getElementById('bikeSuggestions');
                if (suggestions) suggestions.style.display = 'none';
                const chips = document.getElementById('selectedBikeChips');
                if (chips) chips.innerHTML = '';
                const search = document.getElementById('bikePlateSearch');
                if (search) search.value = '';

                document.getElementById('pickModal').classList.add('open');
            },

            closeModal: function () {
                document.getElementById('pickModal').classList.remove('open');
                // Reset bike search and chips
                const bikeSearch = document.getElementById('bikePlateSearch');
                if (bikeSearch) bikeSearch.value = '';
                const bikeSuggestions = document.getElementById('bikeSuggestions');
                if (bikeSuggestions) bikeSuggestions.style.display = 'none';
                const bikeChips = document.getElementById('selectedBikeChips');
                if (bikeChips) bikeChips.innerHTML = '';
            },

            onProductChange: function () {
                const id = document.getElementById('pickProductSelect').value;
                const item = this.data.find(i => i.id?.toString() === id.toString());
                if (item) {
                    document.getElementById('pickProductId').value = item.id;
                    document.getElementById('pickQuantity').max = item.stock;
                }
            },

            // Stub â€” this function was removed when the modal was redesigned to use
            // autocomplete chips. Kept here so cached browser versions don't crash.
            renderBikeSelector: function () { },

            renderHistory: function () {
                const container = document.getElementById('historyList');
                if (!container) return;
                container.innerHTML = '';

                try {
                    // Sync: Combine SALES (transactions) and legacy MAPPINGS (individual picks)
                    let combinedHistory = [];
                    const txKeySet = new Set();

                    // 1. Load from SALES (type: 'issue') - The primary source
                    const issueSales = (this.sales || []).filter(s => s && s.type === 'issue');
                    issueSales.forEach(s => {
                        try {
                            const dateObj = new Date(s.date);
                            const dateStr = isNaN(dateObj.getTime()) ? 'Invalid' : dateObj.toDateString();

                            combinedHistory.push({
                                id: s.id,
                                source: 'sale',
                                date: s.date,
                                mechanic: s.mechanic || 'Unknown',
                                bike: s.bike || 'â€”',
                                user: s.user || 'Admin',
                                items: (s.items || []).map(it => ({
                                    name: it.name || 'Unknown',
                                    qty: it.qty || 0,
                                    productId: it.productId
                                }))
                            });

                            // Mark fingerprints for partial deduplication
                            const txFingerprint = `${s.mechanic}_${s.bike}_${dateStr}`;
                            txKeySet.add(txFingerprint);

                            // Also track by items to be even safer
                            const itemsFingerprint = (s.items || []).map(it => `${it.productId}_${it.qty}`).sort().join('|');
                            txKeySet.add(`${txFingerprint}_${itemsFingerprint}`);
                        } catch (e) { console.error('Error processing sales record:', e); }
                    });

                    // 2. Load from MAPPINGS (Legacy/Backup) - "Bring all back"
                    const mappingGroups = new Map();
                    (this.mappings || []).forEach(m => {
                        try {
                            const dateObj = new Date(m.date);
                            const dateStr = isNaN(dateObj.getTime()) ? 'Invalid' : dateObj.toDateString();
                            const txFingerprint = `${m.mechanicName}_${m.bikePlate}_${dateStr}`;
                            const itemFingerprint = `${m.productId}_${m.quantity}`;

                            // Only skip if EXACTLY the same fingerprint (mechanic + bike + date + item)
                            // This ensures if Saturday's data is only in MAPPINGS, it's NOT skipped.
                            if (!txKeySet.has(`${txFingerprint}_${itemFingerprint}`)) {
                                const groupKey = m.issueId || `legacy_${txFingerprint}_${m.id}`;
                                if (!mappingGroups.has(groupKey)) {
                                    mappingGroups.set(groupKey, {
                                        id: m.issueId || m.id,
                                        source: 'mapping',
                                        date: m.date,
                                        mechanic: m.mechanicName || 'Unknown',
                                        bike: m.bikePlate || 'â€”',
                                        user: 'Local Sync',
                                        items: []
                                    });
                                }
                                mappingGroups.get(groupKey).items.push({
                                    name: m.productName,
                                    qty: m.quantity,
                                    productId: m.productId
                                });
                            }
                        } catch (e) { console.error('Error processing mapping record:', e); }
                    });

                    // Add grouped mappings to history
                    mappingGroups.forEach(tx => combinedHistory.push(tx));

                    // 3. Sort by date DESC
                    combinedHistory.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return (isNaN(dateB.getTime()) ? 0 : dateB.getTime()) - (isNaN(dateA.getTime()) ? 0 : dateA.getTime());
                    });

                    if (combinedHistory.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; color: #94a3b8; padding: 40px 20px;">
                                <i class="fas fa-history" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.2;"></i>
                                <p style="font-size: 0.9rem;">No recent history found.</p>
                            </div>
                        `;
                        return;
                    }

                    combinedHistory.forEach(tx => {
                        try {
                            const card = document.createElement('div');
                            card.className = 'history-card';

                            const itemsHtml = (tx.items || []).map(it => {
                                const product = this.data.find(p => p.id?.toString() === it.productId?.toString());
                                const stock = product ? product.stock : 'N/A';
                                return `
                                    <div class="history-item-row" style="margin-bottom: 4px;">
                                        <span class="history-item-name" style="flex: 1; font-size: 0.8rem;">${it.name}</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 0.7rem; color: ${stock <= 5 ? '#ef4444' : '#64748b'}; font-weight: 700; background: #f8fafc; padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
                                                ${stock} Available in Stock
                                            </span>
                                            <span class="history-item-qty" style="min-width: 24px; text-align: center;">${it.qty}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            const txDate = new Date(tx.date);
                            const formattedDate = isNaN(txDate.getTime()) ? 'Unknown' : txDate.toLocaleDateString(undefined, {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            card.innerHTML = `
                                <div class="history-header">
                                    <div class="history-meta">
                                        <span style="font-weight: 700; color: #1e293b; font-size: 0.85rem;">
                                            <i class="fas fa-wrench" style="color: #6366f1; width: 14px;"></i> ${tx.mechanic || 'Unknown'}
                                        </span>
                                        <span><i class="fas fa-motorcycle" style="color: #64748b; width: 14px;"></i> ${tx.bike || 'â€”'}</span>
                                    </div>
                                    <span class="history-id">#${(tx.id || 'N/A').toString().slice(-6).toUpperCase()}</span>
                                </div>
                                <div class="history-body">
                                    ${itemsHtml}
                                </div>
                                <div class="history-footer">
                                    <span><i class="far fa-clock"></i> ${formattedDate}</span>
                                    <span style="font-size: 0.7rem; font-style: italic;">By: ${tx.user || 'User'}</span>
                                </div>
                            `;
                            container.appendChild(card);
                        } catch (e) {
                            console.error('Error rendering history card:', e, tx);
                        }
                    });
                } catch (generalError) {
                    console.error('Fatal error in renderHistory:', generalError);
                    container.innerHTML = `<div style="color: red; padding: 20px;">Error loading history. Check console for details.</div>`;
                }
            },

            printAuditReport: function () {
                const tbody = document.querySelector('#auditReportTable tbody');
                const dateSpan = document.getElementById('auditReportDate');

                if (!tbody || !dateSpan) return;

                dateSpan.textContent = new Date().toLocaleString();
                tbody.innerHTML = '';

                const history = [...this.mappings].reverse();

                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No issuance records found.</td></tr>';
                } else {
                    history.forEach(m => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${m.pickedDate ? new Date(m.pickedDate).toLocaleDateString() : new Date(m.date).toLocaleDateString()}</td>
                            <td>${new Date(m.date).toLocaleString()}</td>
                            <td>${m.issueId || '-'}</td>
                            <td>${m.productName}</td>
                            <td>${m.mechanicName}</td>
                            <td>${m.bikePlate}</td>
                            <td>${m.quantity}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                window.print();
            },

            saveMapping: async function (isBulk = false) {
                const prefix = isBulk ? 'bulk' : 'pick';
                const mechanicName = document.getElementById(`${prefix}Mechanic`).value;
                const pickedDateVal = document.getElementById(`${prefix}Date`).value;
                const issueId = document.getElementById(`${prefix}IssueId`).value;

                // Get selected bikes from chips
                const chipsId = isBulk ? 'bulkBikeChips' : 'selectedBikeChips';
                const chipsContainer = document.getElementById(chipsId);
                const selectedPlates = Array.from(chipsContainer.querySelectorAll('.bike-chip')).map(c => c.dataset.plate);
                const bikePlateString = selectedPlates.join(', ');

                if (!mechanicName || selectedPlates.length === 0) {
                    alert('Please select a mechanic and at least one bike.');
                    return;
                }

                let itemsToIssue = [];

                if (isBulk) {
                    itemsToIssue = this.cart.map(c => ({
                        productId: c.id,
                        name: c.name,
                        sku: c.sku,
                        qty: c.qty,
                        price: c.price || 0,
                        total: (c.price || 0) * c.qty
                    }));
                } else {
                    const productId = document.getElementById('pickProductId').value;
                    const quantity = parseInt(document.getElementById('pickQuantity').value);
                    const prod = this.data.find(p => p.id?.toString() === productId.toString());

                    if (!productId || isNaN(quantity)) {
                        alert('Please select a product.');
                        return;
                    }

                    itemsToIssue = [{
                        productId: productId,
                        name: prod ? prod.name : 'Unknown',
                        sku: prod ? prod.sku : '',
                        qty: quantity,
                        price: prod ? prod.price : 0,
                        total: (prod ? prod.price : 0) * quantity
                    }];
                }

                try {
                    const isMigrated = localStorage.getItem(App.KEYS.DB_MIGRATED) === 'true';
                    const currentUser = App.getCurrentUser();

                    // Load current sales to ensure we don't drop anything
                    this.sales = JSON.parse(localStorage.getItem(App.KEYS.SALES)) || [];

                    // 1. Validate Stock for all items
                    for (const item of itemsToIssue) {
                        const productIndex = this.data.findIndex(p => p.id?.toString() === item.productId?.toString());
                        if (productIndex === -1 || this.data[productIndex].stock < item.qty) {
                            alert(`Insufficient stock for ${item.name}`);
                            return;
                        }
                    }

                    // 2. Perform Updates
                    for (const item of itemsToIssue) {
                        const productIndex = this.data.findIndex(p => p.id?.toString() === item.productId?.toString());
                        this.data[productIndex].stock -= item.qty;

                        this.mappings.push({
                            id: Date.now() + Math.random(),
                            issueId: issueId,
                            productId: item.productId,
                            productName: item.name,
                            mechanicName: mechanicName,
                            bikePlate: bikePlateString,
                            quantity: item.qty,
                            pickedDate: pickedDateVal,
                            date: new Date().toISOString()
                        });

                        if (isMigrated) {
                            try {
                                const mechanics = JSON.parse(localStorage.getItem(App.KEYS.MECHANICS)) || [];
                                const mech = mechanics.find(m => m.name === mechanicName);
                                const bikes = JSON.parse(localStorage.getItem(App.KEYS.BIKES)) || [];
                                const bike = bikes.find(b => b.plate === selectedPlates[0]);

                                await App.apiCall('/transactions', 'POST', {
                                    productId: item.productId,
                                    transactionType: 'issue',
                                    quantity: -item.qty,
                                    mechanicId: mech ? mech.id : null,
                                    bikeId: bike ? bike.id : null,
                                    referenceId: issueId,
                                    date: pickedDateVal ? new Date(pickedDateVal).toISOString() : new Date().toISOString(),
                                    notes: `Issued to ${mechanicName} for bike ${bikePlateString}`
                                });
                            } catch (apiError) { console.warn('Sync failed:', apiError); }
                        }
                    }

                    // 3. Record Sales
                    const saleDate = pickedDateVal ? new Date(pickedDateVal) : new Date();
                    this.sales.push({
                        id: Date.now(),
                        date: isNaN(saleDate.getTime()) ? new Date().toISOString() : saleDate.toISOString(),
                        type: 'issue',
                        items: itemsToIssue,
                        total: itemsToIssue.reduce((sum, it) => sum + it.total, 0),
                        mechanic: mechanicName,
                        bike: bikePlateString,
                        status: 'completed',
                        user: currentUser ? currentUser.name : 'Unknown'
                    });

                    // 4. Save
                    localStorage.setItem(App.KEYS.INVENTORY, JSON.stringify(this.data));
                    localStorage.setItem(App.KEYS.MAPPINGS, JSON.stringify(this.mappings));
                    localStorage.setItem(App.KEYS.SALES, JSON.stringify(this.sales));

                } catch (error) {
                    console.error('Save failed:', error);
                    App.showToast(`Error occurred while saving: ${error.message || 'Unknown error'}`, 'error');
                    return; // Stop if data saving itself failed
                }

                // 5. Cleanup (Moved outside try-catch to isolate UI/cache issues from data saving)
                try {
                    this.cart = [];
                    this.renderCart();
                    this.closeModal();
                    this.closeBulkModal();
                    this.renderCards();
                    this.renderHistory();
                    App.showToast('Parts issued successfully!');
                    window.dispatchEvent(new Event('storage'));
                } catch (uiError) {
                    console.warn('UI Cleanup Error (Likely Cache):', uiError);
                    // Even if closeModal fails, the data is saved, so we just reload to be safe
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        };

        // Make PickItem accessible to inline onclick="PickItem.*" handlers
        window.PickItem = PickItem;

        document.addEventListener('DOMContentLoaded', async () => {
            await App.init();
            PickItem.init();

            // Header User Info (with safety checks)
            const user = App.getCurrentUser();
            if (user) {
                const displayName = user.name || user.firstName || user.email || 'User';
                const fullName = displayName + (user.lastName ? ' ' + user.lastName : '');
                const userNameEl = document.getElementById('userName');
                const userInitialsEl = document.getElementById('userInitials');

                if (userNameEl) userNameEl.textContent = displayName;
                if (userInitialsEl) userInitialsEl.textContent = fullName.split(' ').filter(Boolean).map(n => n[0]).join('').toUpperCase() || 'U';
            }
        });
    </script>
</body>

</html>