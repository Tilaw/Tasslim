<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Item - Spare Parts Inventory System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            #auditReportContainer,
            #auditReportContainer * {
                visibility: visible;
            }

            #auditReportContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .app-container {
                display: block !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            th,
            td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
                font-size: 12px;
            }

            th {
                background-color: #f2f2f2 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        #auditReportContainer {
            display: none;
            padding: 20px;
            background: white;
        }

        .audit-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .audit-footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
        }

        .sig-box {
            width: 200px;
            text-align: center;
        }

        .sig-line {
            border-top: 1px solid #333;
            margin-bottom: 5px;
        }

        .pick-container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* Quick Issue Form Styles */
        .quick-issue-card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .search-area {
            position: relative;
            margin-bottom: 25px;
        }

        .main-search-input {
            width: 100%;
            height: 60px;
            border-radius: 16px;
            border: 2px solid #f1f5f9;
            padding: 0 50px 0 25px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .main-search-input:focus {
            border-color: var(--accent-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

        .search-icon-inside {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.2rem;
        }

        .selection-preview {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
            /* Shown when item selected */
        }

        .selected-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assignment-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-label-pill {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
            display: block;
            letter-spacing: 0.5px;
        }

        /* History Bottom Styles */
        .recent-history-section {
            margin-top: 40px;
            border-top: 2px dashed #e2e8f0;
            padding-top: 30px;
        }

        .history-grid-simplified {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .assignment-grid {
                grid-template-columns: 1fr;
            }

            .pick-container {
                padding: 10px;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            position: sticky;
            bottom: 0;
            background: white;
            z-index: 10;
        }

        .close-modal {
            font-size: 1.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #ef4444;
        }

        /* Parts List Styles */
        .parts-list {
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .part-list-item {
            display: grid;
            grid-template-columns: 1fr 100px 50px;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
        }

        .part-list-item:last-child {
            border-bottom: none;
        }

        .part-list-header {
            background: #f8fafc;
            font-weight: 700;
            font-size: 0.8rem;
            color: #64748b;
            text-transform: uppercase;
        }

        /* History Flow Styles */
        .history-card-structured {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .history-card-structured:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .history-flow-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .flow-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-color);
        }

        .flow-line {
            width: 2px;
            height: 20px;
            background: #e2e8f0;
            margin-left: 3px;
        }

        .history-parts-table {
            width: 100%;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .history-parts-table th {
            text-align: left;
            color: #64748b;
            padding-bottom: 5px;
            border-bottom: 1px solid #f1f5f9;
        }

        .history-parts-table td {
            padding: 5px 0;
            border-bottom: 1px dotted #f1f5f9;
        }

        /* Confirmation Modal Specifics */
        .confirm-modal-content {
            max-width: 400px;
            text-align: center;
            padding: 40px 30px;
        }

        .confirm-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 20px;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirm-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .confirm-text {
            color: #64748b;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .confirm-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cogs" style="margin-right: 10px;"></i>
                Tasslim Parts Manager
            </div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> <span
                            data-i18n="dashboard">Dashboard</span></a></li>
                <li><a href="inventory.html" class="nav-link"><i class="fas fa-boxes"></i> <span
                            data-i18n="inventory">Inventory</span></a></li>
                <li><a href="purchase-order.html" class="nav-link"><i class="fas fa-shopping-cart"></i> <span>Purchase
                            Order</span></a></li>
                <li><a href="issue-part.html" class="nav-link active"><i class="fas fa-hand-holding"></i> <span
                            data-i18n="pickItem">Issue Part (Mapping)</span></a></li>
                <li><a href="oil-change.html" class="nav-link"><i class="fas fa-oil-can"></i> <span
                            data-i18n="oilChange">Oil Change</span></a></li>
                <li><a href="bike-history.html" class="nav-link"><i class="fas fa-book"></i> <span
                            data-i18n="bikeHistory">Bike History</span></a></li>
                <li><a href="suppliers.html" class="nav-link"><i class="fas fa-truck"></i> <span
                            data-i18n="suppliers">Suppliers</span></a></li>
                <li><a href="mechanics.html" class="nav-link"><i class="fas fa-wrench"></i> <span
                            data-i18n="mechanics">Mechanics</span></a></li>
                <li><a href="mechanic-history.html" class="nav-link"><i class="fas fa-history"></i> <span
                            data-i18n="mechanicHistory">Mechanic History</span></a></li>
                <li><a href="users.html" class="nav-link"><i class="fas fa-users-cog"></i> <span
                            data-i18n="users">Users</span></a></li>
                <li><a href="riders.html" class="nav-link"><i class="fas fa-id-card"></i> <span>Riders Info</span></a>
                </li>
                <li><a href="bikes.html" class="nav-link"><i class="fas fa-motorcycle"></i> <span
                            data-i18n="bikes">Bikes</span></a></li>
                <li><a href="reports.html" class="nav-link"><i class="fas fa-chart-line"></i> <span
                            data-i18n="reports">Reports</span></a></li>
                <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> <span
                            data-i18n="settings">Settings</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button class="nav-link" style="background:none;border:none;width:100%;text-align:left;cursor:pointer;"
                    onclick="App.toggleLanguage()"><i class="fas fa-language"></i> <span
                        data-i18n="translate">Translate</span></button>
                <a href="#" onclick="App.logout()" class="nav-link"><i class="fas fa-sign-out-alt"></i> <span
                        data-i18n="logout">Logout</span></a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="menu-toggle" onclick="App.toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title" data-i18n="pickItem">Pick Item (Issuance / Mapping)</div>
                <div class="header-actions hide-on-mobile" style="display: flex; gap: 15px; align-items: center;">
                    <div class="user-profile">
                        <div class="user-avatar" id="userInitials">AU</div>
                        <span id="userName">Admin User</span>
                    </div>
                </div>
            </header>

            <div class="pick-container">
                <!-- TRIGGER BUTTON -->
                <div style="margin-bottom: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="PickItem.openModal()"
                        style="padding: 15px 40px; border-radius: 50px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);">
                        <i class="fas fa-plus-circle"></i> ISSUE NEW PART
                    </button>
                </div>

                <!-- ISSUANCE MODAL -->
                <div id="issuanceModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 style="margin:0; font-size: 1.25rem;"><i class="fas fa-hand-holding"></i> Issue Part
                                Assignment</h2>
                            <i class="fas fa-times close-modal" onclick="PickItem.closeModal()"></i>
                        </div>
                        <div class="modal-body">
                            <!-- STEP 1: BIKE SELECTION -->
                            <div class="form-group">
                                <label class="form-label-pill">1. Select Bike (Search Plate #)</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="modalBikeSearch" class="form-control"
                                        placeholder="Type plate number..." style="height: 50px; border-radius: 12px;"
                                        autocomplete="off" onkeyup="PickItem.handleBikeSearch(event)">
                                    <div id="modalBikeSuggestions" class="autocomplete-dropdown"></div>
                                </div>
                                <div id="selectedBikeDisplay" style="margin-top: 10px; display: none;">
                                    <div class="bike-chip" id="activeBikeChip"
                                        style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 12px;">
                                        <i class="fas fa-motorcycle"></i> <span id="activeBikePlate"></span>
                                        <span class="remove-chip" onclick="PickItem.clearBike()"
                                            style="color: white; opacity: 0.8;">&times;</span>
                                    </div>
                                </div>
                            </div>

                            <hr style="border: none; border-top: 1px solid #f1f5f9; margin: 25px 0;">

                            <!-- STEP 2: RIDER & RECEIVER DETAILS -->
                            <h3 class="form-label-pill" style="margin-bottom: 15px; color: var(--primary-color);">2.
                                Tracking Details</h3>
                            <div class="assignment-grid">
                                <div class="form-group">
                                    <label class="form-label-pill">Rider Name</label>
                                    <input type="text" id="riderName" class="form-control"
                                        placeholder="Enter rider name" style="border-radius: 10px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label-pill">Rider Number</label>
                                    <input type="text" id="riderNumber" class="form-control"
                                        placeholder="Enter rider phone" style="border-radius: 10px;">
                                </div>
                            </div>
                            <div class="assignment-grid">
                                <div class="form-group">
                                    <label class="form-label-pill">Rider ID</label>
                                    <input type="text" id="riderId" class="form-control" placeholder="Enter rider ID"
                                        style="border-radius: 10px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label-pill">Receiver Name (Who is coming for part?)</label>
                                    <select id="receiverName" class="form-control"
                                        style="height: 50px; border-radius: 10px;">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <hr style="border: none; border-top: 1px solid #f1f5f9; margin: 25px 0;">

                            <!-- STEP 3: MECHANIC -->
                            <div class="form-group">
                                <label class="form-label-pill">3. Assign to Mechanic (Who is working on bike?)</label>
                                <select id="modalMechanicSelect" class="form-control"
                                    style="height: 50px; border-radius: 12px;">
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <hr style="border: none; border-top: 1px solid #f1f5f9; margin: 25px 0;">

                            <!-- STEP 4: DYNAMIC PART ROWS -->
                            <div class="form-group">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <label class="form-label-pill" style="margin-bottom: 0;">4. Parts to Issue (Qty: 1
                                        per row)</label>
                                    <button class="btn btn-secondary"
                                        style="padding: 8px 15px; font-size: 0.85rem; border-radius: 10px; display: flex; align-items: center; gap: 5px;"
                                        onclick="PickItem.addPartRow()">
                                        <i class="fas fa-plus"></i> ADD PART ROW
                                    </button>
                                </div>

                                <div id="dynamicPartsContainer"
                                    style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- Dynamic Rows will be injected here -->
                                </div>

                                <div id="noPartsSelectedMsg"
                                    style="padding: 40px; text-align: center; color: #94a3b8; font-style: italic; background: #f8fafc; border-radius: 16px; border: 2px dashed #e2e8f0; margin-top: 10px;">
                                    No parts added. Click "ADD PART ROW" to start.
                                </div>
                            </div>

                            <div class="assignment-grid" style="margin-top: 25px;">
                                <div class="form-group">
                                    <label class="form-label-pill">Issue ID</label>
                                    <input type="text" id="modalIssueId" class="form-control" readonly
                                        style="background: #f8fafc; height: 45px; border-radius: 10px; border-color: #f1f5f9;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label-pill">Date</label>
                                    <input type="date" id="modalDate" class="form-control"
                                        style="height: 45px; border-radius: 10px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-link" onclick="PickItem.closeModal()">Cancel</button>
                            <button class="btn btn-primary"
                                style="padding: 0 30px; height: 50px; border-radius: 12px; font-weight: 700;"
                                onclick="PickItem.confirmIssuance()">
                                <i class="fas fa-check-circle"></i> CONFIRM ISSUANCE
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ISSUANCE HISTORY (BOTTOM) -->
                <div class="recent-history-section">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 1.25rem;"><i class="fas fa-history"></i> Recent Issuance Logs
                        </h3>
                        <button class="btn btn-secondary" onclick="PickItem.printAuditReport()"
                            style="padding: 8px 15px; border-radius: 10px;">
                            <i class="fas fa-print"></i> Print Audit Report
                        </button>
                    </div>
                    <div id="historyList" class="history-grid-simplified"
                        style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Populated by JS with history-card-structured -->
                    </div>
                </div>

                <!-- Hidden Audit Report for Printing -->
                <div id="auditReportContainer">
                    <div class="audit-header">
                        <div style="font-size: 14px; font-weight: bold; color: #666; margin-bottom: 5px;">TASSLIM
                            WORKSHOP MANAGEMENT</div>
                        <h2 style="margin: 0; text-transform: uppercase; letter-spacing: 1px;">Spare Parts Issuance Log
                            (Audit Report)</h2>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">Report Date: <span id="auditReportDate"></span>
                        </p>
                    </div>

                    <table id="auditReportTable">
                        <thead>
                            <tr>
                                <th>Date Picked</th>
                                <th>Logged At</th>
                                <th>Issue ID</th>
                                <th>Product Name</th>
                                <th>Mechanic</th>
                                <th>Bike Plate(s)</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>

                    <div class="audit-footer">
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Technician Signature</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Workshop Supervisor</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-line"></div>
                            <div style="font-size: 12px; font-weight: bold;">Storekeeper Signature</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/app.js"></script>
    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal-content"
            style="max-width: 400px; text-align: center; padding: 40px 30px;">
            <div class="confirm-icon" style="font-size: 4rem; color: #ef4444; margin-bottom: 20px;">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="confirm-title"
                style="font-size: 1.5rem; font-weight: 800; color: #1e293b; margin-bottom: 10px;">Are you sure?</div>
            <div id="confirmMessage" class="confirm-text"
                style="color: #64748b; margin-bottom: 30px; line-height: 1.6;">This action cannot be undone.</div>
            <div class="confirm-actions" style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-secondary" style="padding: 12px 30px; border-radius: 12px; font-weight: 700;"
                    onclick="PickItem.closeConfirm()">Cancel</button>
                <button id="confirmBtn" class="btn btn-danger"
                    style="padding: 12px 30px; border-radius: 12px; font-weight: 700; background: #ef4444; color: white;">Yes,
                    Delete</button>
            </div>
        </div>
    </div>

    <script>
        const PickItem = {
            version: "1.2.0-debug",
            data: [],
            mappings: [],
            sales: [],
            selectedParts: [],
            selectedBike: null,

            init: function () {
                console.log('PickItem Initializing, Version:', this.version);
                this.loadData();
                this.renderHistory();
                this.populateMechanics();
            },

            loadData: function () {
                this.data = JSON.parse(localStorage.getItem(App.KEYS.INVENTORY)) || [];
                this.mappings = JSON.parse(localStorage.getItem(App.KEYS.MAPPINGS)) || [];
                this.sales = JSON.parse(localStorage.getItem(App.KEYS.SALES)) || [];
            },

            populateMechanics: function () {
                const mechanics = JSON.parse(localStorage.getItem(App.KEYS.MECHANICS)) || [];
                const select = document.getElementById('modalMechanicSelect');
                const receiverSelect = document.getElementById('receiverName');
                if (!select || !receiverSelect) return;

                const options = '<option value="">-- Choose Mechanic --</option>' +
                    mechanics.map(m => `<option value="${m.name}">${m.name}</option>`).join('');

                select.innerHTML = options;
                receiverSelect.innerHTML = options;
            },

            openModal: function () {
                this.resetForm();
                document.getElementById('issuanceModal').classList.add('active');
                document.body.style.overflow = 'hidden';
            },

            closeModal: function () {
                document.getElementById('issuanceModal').classList.remove('active');
                document.body.style.overflow = 'auto';
            },

            openConfirm: function (message, onConfirm) {
                console.log('openConfirm called with message:', message);
                const modal = document.getElementById('confirmModal');
                const msgEl = document.getElementById('confirmMessage');
                const btn = document.getElementById('confirmBtn');

                console.log('Confirm Modal Elements:', { modal, msgEl, btn });

                if (!modal || !msgEl || !btn) {
                    console.error('CRITICAL: Confirmation modal elements missing! Check HTML IDs.');
                    // Fallback to native confirm if custom modal fails
                    if (confirm(message || 'Are you sure?')) {
                        onConfirm();
                    }
                    return;
                }

                msgEl.textContent = message || 'This action cannot be undone.';
                modal.classList.add('active');

                // Use a one-time click handler
                btn.onclick = () => {
                    onConfirm();
                    this.closeConfirm();
                };
            },

            closeConfirm: function () {
                const modal = document.getElementById('confirmModal');
                if (modal) modal.classList.remove('active');
            },

            resetForm: function () {
                this.selectedBike = null;

                // Clear inputs
                document.getElementById('modalBikeSearch').value = '';
                document.getElementById('riderName').value = '';
                document.getElementById('riderNumber').value = '';
                document.getElementById('riderId').value = '';
                document.getElementById('receiverName').value = '';
                document.getElementById('modalMechanicSelect').value = '';

                // Reset displays
                document.getElementById('selectedBikeDisplay').style.display = 'none';
                document.getElementById('activeBikePlate').textContent = '';
                document.getElementById('modalBikeSearch').style.display = 'block';

                // Reset Dynamic Rows
                document.getElementById('dynamicPartsContainer').innerHTML = '';
                this.addPartRow(); // Start with one empty row

                const issueIdInput = document.getElementById('modalIssueId');
                if (issueIdInput) issueIdInput.value = 'ISS-' + Math.random().toString(36).substr(2, 9).toUpperCase();

                const dateInput = document.getElementById('modalDate');
                if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            },

            handleBikeSearch: function (e) {
                const query = e.target.value.toLowerCase();
                const dropdown = document.getElementById('modalBikeSuggestions');
                const bikes = JSON.parse(localStorage.getItem(App.KEYS.BIKES)) || [];

                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = bikes.filter(b => b.plate.toLowerCase().includes(query)).slice(0, 5);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(b => `
                    <div class="autocomplete-item" onclick="PickItem.selectBike('${b.plate}')">
                        <div class="plate">${b.plate}</div>
                        <div class="meta">${b.model || ''}</div>
                    </div>
                `).join('');
                dropdown.style.display = 'block';

                if (e.key === 'Enter' && matches.length > 0) {
                    this.selectBike(matches[0].plate);
                }
            },

            selectBike: function (plate) {
                this.selectedBike = plate;
                document.getElementById('modalBikeSearch').value = '';
                document.getElementById('modalBikeSearch').style.display = 'none';
                document.getElementById('modalBikeSuggestions').style.display = 'none';

                document.getElementById('activeBikePlate').textContent = plate;
                document.getElementById('selectedBikeDisplay').style.display = 'block';
            },

            clearBike: function () {
                this.selectedBike = null;
                document.getElementById('selectedBikeDisplay').style.display = 'none';
                document.getElementById('modalBikeSearch').style.display = 'block';
                document.getElementById('modalBikeSearch').focus();
            },

            addPartRow: function () {
                const container = document.getElementById('dynamicPartsContainer');
                const rowId = 'row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4);

                const row = document.createElement('div');
                row.className = 'part-row-entry';
                row.id = rowId;
                row.style = 'display: flex; gap: 10px; align-items: flex-start; background: white; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; position: relative; transition: all 0.2s;';

                row.innerHTML = `
                    <div style="flex-grow: 1; position: relative;">
                        <input type="text" class="form-control row-part-search" 
                            placeholder="Type part name or SKU..." 
                            style="height: 45px; border-radius: 10px; border-color: #cbd5e1;"
                            onkeyup="PickItem.handleRowSearch(event, '${rowId}')"
                            autocomplete="off">
                        <div class="row-suggestions autocomplete-dropdown" style="width: 100%; top: 50px;"></div>
                        <div class="selected-row-part" style="display: none; padding: 8px 0; font-weight: 600; color: var(--primary-color);">
                            <i class="fas fa-check-circle"></i> <span class="part-name-display"></span>
                        </div>
                        <input type="hidden" class="row-part-id">
                    </div>
                    <div style="width: 50px; height: 45px; background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #64748b; border: 1px solid #e2e8f0;">
                        1
                    </div>
                    <button class="btn" style="height: 45px; width: 45px; border-radius: 10px; background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; display: flex; align-items: center; justify-content: center;" onclick="PickItem.removeRow('${rowId}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;

                container.appendChild(row);
                document.getElementById('noPartsSelectedMsg').style.display = 'none';

                const input = row.querySelector('.row-part-search');
                input.focus();
            },

            removeRow: function (rowId) {
                const row = document.getElementById(rowId);
                if (!row) return;

                const partId = row.querySelector('.row-part-id').value;

                const doRemove = () => {
                    row.remove();
                    const container = document.getElementById('dynamicPartsContainer');
                    if (container.children.length === 0) {
                        document.getElementById('noPartsSelectedMsg').style.display = 'block';
                    }
                };

                if (partId) {
                    // Row has a part, ask for confirmation
                    this.openConfirm('Are you sure you want to remove this part from the list?', doRemove);
                } else {
                    // Row is empty, just remove
                    doRemove();
                }
            },

            handleRowSearch: function (e, rowId) {
                const query = e.target.value.toLowerCase();
                const row = document.getElementById(rowId);
                const dropdown = row.querySelector('.row-suggestions');

                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Get all selected IDs to exclude from search results
                const selectedIds = Array.from(document.querySelectorAll('.row-part-id'))
                    .map(input => input.value)
                    .filter(id => id !== '');

                const matches = this.data.filter(p => {
                    const matchesQuery = p.name.toLowerCase().includes(query) || (p.sku && p.sku.toLowerCase().includes(query));
                    const isAlreadySelected = selectedIds.includes(p.id.toString());
                    return matchesQuery && !isAlreadySelected;
                }).slice(0, 8);

                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" onclick="PickItem.selectPartForRow('${rowId}', '${p.id}', '${p.name.replace(/'/g, "\\'")}', '${p.sku || 'N/A'}', ${p.stock})">
                        <div>
                            <div class="plate">${p.name}</div>
                            <div class="meta">SKU: ${p.sku || 'N/A'} | Stock: ${p.stock}</div>
                        </div>
                        <i class="fas fa-plus-circle" style="color: var(--accent-color);"></i>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            },

            selectPartForRow: function (rowId, partId, partName, sku, stock) {
                if (stock <= 0) {
                    App.showToast('Item is out of stock!', 'error');
                    return;
                }

                // DUPLICATE CHECK
                const existingRows = Array.from(document.getElementById('dynamicPartsContainer').children);
                const isDuplicate = existingRows.some(row => {
                    return row.id !== rowId && row.querySelector('.row-part-id').value === partId.toString();
                });

                if (isDuplicate) {
                    App.showToast('This part is already selected in another row!', 'error');
                    return;
                }

                const row = document.getElementById(rowId);

                // Update display
                row.querySelector('.row-part-search').style.display = 'none';
                row.querySelector('.row-suggestions').style.display = 'none';

                const display = row.querySelector('.selected-row-part');
                display.querySelector('.part-name-display').textContent = `${partName} (${sku})`;
                display.style.display = 'block';

                row.querySelector('.row-part-id').value = partId;
                row.style.borderColor = 'var(--primary-color)';
                row.style.background = '#f0f9ff';
            },

            confirmIssuance: async function () {
                if (!this.selectedBike) {
                    App.showToast('Please select a bike first.', 'error');
                    return;
                }

                const rows = Array.from(document.getElementById('dynamicPartsContainer').children);
                if (rows.length === 0) {
                    App.showToast('Please add at least one part.', 'error');
                    return;
                }

                // CRITICAL: Validation - Check if all rows have a selected part
                const itemsToIssue = [];
                let hasEmptyRow = false;

                for (const row of rows) {
                    const id = row.querySelector('.row-part-id').value;
                    if (!id) {
                        hasEmptyRow = true;
                        row.style.borderColor = '#ef4444';
                        row.style.background = '#fef2f2';
                    } else {
                        const product = this.data.find(p => p.id?.toString() === id.toString());
                        if (product) {
                            itemsToIssue.push({
                                id: product.id,
                                name: product.name,
                                sku: product.sku || 'N/A',
                                qty: 1,
                                price: product.price || 0,
                                stock: product.stock
                            });
                        }
                    }
                }

                if (hasEmptyRow) {
                    App.showToast('Please select a part for every row or delete empty rows.', 'error');
                    return;
                }

                const mechanicName = document.getElementById('modalMechanicSelect').value;
                const receiverName = document.getElementById('receiverName').value;
                const issueId = document.getElementById('modalIssueId').value;
                const pickedDateVal = document.getElementById('modalDate').value;
                const riderName = document.getElementById('riderName').value;
                const riderNumber = document.getElementById('riderNumber').value;
                const riderId = document.getElementById('riderId').value;

                if (!mechanicName || !receiverName) {
                    App.showToast('Please select mechanic and receiver.', 'error');
                    return;
                }

                let pickedDateTime = new Date().toISOString();
                if (pickedDateVal) {
                    const selected = new Date(pickedDateVal);
                    const now = new Date();
                    selected.setHours(now.getHours(), now.getMinutes(), now.getSeconds(), now.getMilliseconds());
                    pickedDateTime = selected.toISOString();
                }

                try {
                    const isMigrated = localStorage.getItem(App.KEYS.DB_MIGRATED) === 'true';
                    const currentUser = App.getCurrentUser();
                    const groupId = Date.now();

                    for (const part of itemsToIssue) {
                        const productIndex = this.data.findIndex(p => p.id?.toString() === part.id?.toString());
                        if (productIndex !== -1) {
                            this.data[productIndex].stock -= 1;
                        }

                        this.mappings.push({
                            id: Date.now() + Math.random(),
                            groupId: groupId,
                            issueId: issueId,
                            productId: part.id,
                            productName: part.name,
                            mechanicName: mechanicName,
                            bikePlate: this.selectedBike,
                            quantity: 1,
                            riderName,
                            riderNumber,
                            riderId,
                            receiverName,
                            pickedDate: pickedDateTime,
                            date: new Date().toISOString()
                        });
                    }

                    this.sales.push({
                        id: groupId,
                        date: pickedDateTime,
                        type: 'issue',
                        items: itemsToIssue.map(p => ({
                            productId: p.id,
                            name: p.name,
                            sku: p.sku,
                            qty: 1,
                            price: p.price,
                            total: p.price
                        })),
                        total: itemsToIssue.reduce((sum, p) => sum + (p.price || 0), 0),
                        mechanic: mechanicName,
                        bike: this.selectedBike,
                        riderName,
                        riderNumber,
                        riderId,
                        receiverName,
                        status: 'completed',
                        user: currentUser ? currentUser.name : 'Unknown'
                    });

                    localStorage.setItem(App.KEYS.INVENTORY, JSON.stringify(this.data));
                    localStorage.setItem(App.KEYS.MAPPINGS, JSON.stringify(this.mappings));
                    localStorage.setItem(App.KEYS.SALES, JSON.stringify(this.sales));

                    if (isMigrated) {
                        try {
                            const bikesStore = JSON.parse(localStorage.getItem(App.KEYS.BIKES)) || [];
                            const b = bikesStore.find(bike => bike.plate === this.selectedBike);
                            const mechsStore = JSON.parse(localStorage.getItem(App.KEYS.MECHANICS)) || [];
                            const m = mechsStore.find(mech => mech.name === mechanicName);

                            for (const part of itemsToIssue) {
                                await App.apiCall('/transactions', 'POST', {
                                    productId: part.id,
                                    transactionType: 'issue',
                                    quantity: -1,
                                    mechanicId: m ? m.id : null,
                                    bikeId: b ? b.id : null,
                                    referenceId: issueId,
                                    date: pickedDateTime,
                                    notes: `Dynamic Row Issue to ${mechanicName}. Rider: ${riderName}`
                                });
                            }
                        } catch (apiError) { console.warn('Sync failed:', apiError); }
                    }

                    App.showToast('Issuance recorded successfully!');
                    this.closeModal();
                    this.renderHistory();
                    window.dispatchEvent(new Event('storage'));

                } catch (err) {
                    console.error('Issue failed:', err);
                    App.showToast('Failed to complete issuance.', 'error');
                }
            },

            renderHistory: function () {
                const container = document.getElementById('historyList');
                if (!container) return;
                container.innerHTML = '';

                // Get issuance sales records
                const history = [...this.sales].filter(s => s.type === 'issue').reverse().slice(0, 15);

                if (history.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:40px; background:white; border-radius:16px;">No recent issuances found.</div>';
                    return;
                }

                history.forEach(tx => {
                    const card = document.createElement('div');
                    card.className = 'history-card-structured';

                    const date = new Date(tx.date).toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });

                    // Parts table rows
                    const partsRows = tx.items.map(it => `
                        <tr>
                            <td>${it.name}</td>
                            <td style="text-align: center; font-weight: 700;">${it.qty}</td>
                        </tr>
                    `).join('');

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <span style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">
                                        <i class="fas fa-motorcycle"></i> ${tx.bike}
                                    </span>
                                    <span style="color: #94a3b8; font-size: 0.75rem;">${date}</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #64748b;">Issue ID: <span style="color: #1e293b; font-weight: 600;">${tx.id.toString().slice(-6)}</span></div>
                            </div>
                            <button class="delete-mapping-btn" onclick="PickItem.deleteMapping('${tx.id}', 'sale')" style="background: #fef2f2; color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                            <div>
                                <div class="form-label-pill" style="font-size: 0.65rem; margin-bottom: 4px;">Rider Details</div>
                                <div style="font-weight: 600; font-size: 0.9rem;">${tx.riderName || 'N/A'}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">${tx.riderNumber || 'No Phone'}</div>
                            </div>
                            <div>
                                <div class="form-label-pill" style="font-size: 0.65rem; margin-bottom: 4px;">Personnel</div>
                                <div style="font-size: 0.85rem;"><span style="color: #64748b;">Rec:</span> <span style="font-weight: 600;">${tx.receiverName || 'N/A'}</span></div>
                                <div style="font-size: 0.85rem;"><span style="color: #64748b;">Mech:</span> <span style="font-weight: 600;">${tx.mechanic}</span></div>
                            </div>
                        </div>

                        <table class="history-parts-table">
                            <thead>
                                <tr>
                                    <th>Product Issued</th>
                                    <th style="text-align: center; width: 50px;">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${partsRows}
                            </tbody>
                        </table>
                    `;
                    container.appendChild(card);
                });
            },

            deleteMapping: async function (id, source) {
                this.openConfirm('Revert this issuance and restore stock for all parts in this group?', async () => {
                    try {
                        const tx = this.sales.find(s => s.id.toString() === id.toString());
                        if (!tx) return;

                        tx.items.forEach(it => {
                            const product = this.data.find(p => p.id?.toString() === it.productId?.toString());
                            if (product) product.stock += it.qty;
                        });

                        this.sales = this.sales.filter(s => s.id.toString() !== id.toString());
                        this.mappings = this.mappings.filter(m => (m.groupId || m.issueId || m.id).toString() !== id.toString());

                        localStorage.setItem(App.KEYS.INVENTORY, JSON.stringify(this.data));
                        localStorage.setItem(App.KEYS.SALES, JSON.stringify(this.sales));
                        localStorage.setItem(App.KEYS.MAPPINGS, JSON.stringify(this.mappings));

                        this.renderHistory();
                        App.showToast('Issuance group reverted.');
                    } catch (err) { App.showToast('Revert failed.', 'error'); }
                });
            },

            printAuditReport: function () {
                const tbody = document.querySelector('#auditReportTable tbody');
                const dateSpan = document.getElementById('auditReportDate');
                if (!tbody) return;
                dateSpan.textContent = new Date().toLocaleString();
                tbody.innerHTML = '';

                // For report, we use individual mappings to show each part itemized
                [...this.mappings].reverse().forEach(m => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(m.pickedDate).toLocaleDateString()}</td>
                        <td>${new Date(m.date).toLocaleString()}</td>
                        <td>${m.issueId || '-'}</td>
                        <td>${m.productName}</td>
                        <td>${m.mechanicName}</td>
                        <td>${m.bikePlate}</td>
                        <td>${m.quantity}</td>
                    `;
                    tbody.appendChild(row);
                });
                window.print();
            }
        };

        window.PickItem = PickItem;
        document.addEventListener('DOMContentLoaded', async () => {
            await App.init();
            PickItem.init();
            const user = App.getCurrentUser();
            if (user) {
                const displayName = user.name || user.firstName || user.email || 'User';
                const fullName = displayName + (user.lastName ? ' ' + user.lastName : '');
                const userNameEl = document.getElementById('userName');
                const userInitialsEl = document.getElementById('userInitials');
                if (userNameEl) userNameEl.textContent = displayName;
                if (userInitialsEl) userInitialsEl.textContent = fullName.split(' ').filter(Boolean).map(n => n[0]).join('').toUpperCase() || 'U';
            }
        });
    </script>
</body>

</html>